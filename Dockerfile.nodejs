# =====================================================
# STAGE 1 ‚Äî BUILD STAGE (Temporary)
# Purpose:
# - Install ALL dependencies (including dev)
# - Build the application
# =====================================================

FROM node:20-alpine AS builder

# 1Ô∏è‚É£ Set working directory inside container
WORKDIR /app

# 2Ô∏è‚É£ Copy dependency files first
#    (enables Docker layer caching)
COPY package*.json ./

# 3Ô∏è‚É£ Install dependencies
#    Includes dev deps needed for build
RUN npm ci && npm cache clean --force

# 4Ô∏è‚É£ Copy source code
COPY . .

# 5Ô∏è‚É£ Build the application
#    Creates /app/dist
#    Remove if plain Node.js app
RUN npm run build



# =====================================================
# STAGE 2 ‚Äî PRODUCTION STAGE (Final Image)
# Purpose:
# - Small, secure runtime image
# - Only production dependencies
# =====================================================

FROM node:20-alpine

# 1Ô∏è‚É£ Set working directory
WORKDIR /app

# 2Ô∏è‚É£ Create non-root user (Security Best Practice)
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# 3Ô∏è‚É£ Copy package files
COPY package*.json ./

# 4Ô∏è‚É£ Install ONLY production dependencies
RUN npm ci --omit=dev && npm cache clean --force

# 5Ô∏è‚É£ Copy built files from build stage
COPY --from=builder /app/dist ./dist

# 6Ô∏è‚É£ Change ownership to non-root user
RUN chown -R appuser:appgroup /app

# 7Ô∏è‚É£ Switch to non-root user
USER appuser

# 8Ô∏è‚É£ Expose application port
EXPOSE 3000

# 9Ô∏è‚É£ Health check (for Docker/Kubernetes)
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
  CMD wget -qO- http://localhost:3000/health || exit 1

# üîü Start the application
CMD ["node", "dist/server.js"]
